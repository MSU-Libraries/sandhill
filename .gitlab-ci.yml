image: docker:stable
services:
  - docker:dind

stages:
  - unittest_and_lint
  - build
  - release

variables:
  CONTAINER_IMAGE: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA

before_script:
  - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

unittest_and_lint_job:
  stage: unittest_and_lint
  tags:
    - msul
  script:
    - virtualenv -p python3 $CI_PROJECT_DIR/env
    - $CI_PROJECT_DIR/env/bin/pip install -r $CI_PROJECT_DIR/requirements.txt
    - $CI_PROJECT_DIR/env/bin/pylint-fail-under --fail_under 10.00 sandhill/
    - $CI_PROJECT_DIR/env/bin/pytest --junitxml=report.xml
  artifacts:
    when: always
    reports:
      junit: report.xml

build_job:
  stage: build
  tags:
    - msul
  only:
    - master
  script:
    - docker build --pull -t registry.gitlab.msu.edu/msu-libraries/repo-team/sandhill:latest .
    - docker push registry.gitlab.msu.edu/msu-libraries/repo-team/sandhill:latest

release:
  stage: release
  tags:
    - msul
  when: manual
  only:
    - master
  script:
    - git remote add github git@github.com:MSU-Libraries/sandhill.git
    - git push github master
