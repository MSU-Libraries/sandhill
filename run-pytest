#!/bin/bash

# Find directory where this script resides
CUR_DIR=$( dirname "$0" )
CUR_DIR=$( readlink -f "$CUR_DIR" )

# Script help text
runhelp() {
    echo ""
    echo "Usage: Run Sandhill tests using PyTest"
    echo ""
    echo "Will run tests from: $CUR_DIR"
    echo ""
    echo "FLAGS:"
    echo "  -u|--unit"
    echo "      Run unit tests"
    echo "  -f|--functional"
    echo "      Run functional tests "
    echo ""
}

if [[ -z "$1" || $1 == "-h" || $1 == "--help" || $1 == "help" ]]; then
    runhelp
    exit 0
fi

# Parse flag arguments
while [[ $# -gt 0 ]]; do
    case $1 in
    -f|--functional)
        TEST_TYPE=functional
        shift ;;
    -u|--unit)
        TEST_TYPE=unit
        shift ;;
    *)
        echo "ERROR: Unknown flag: $1"
        exit 1
    esac
done

# Go to the script directory
pushd $CUR_DIR

# Activate the virtualenv
[[ -r env/bin/activate ]] && source env/bin/activate

# Read in local env vars
[[ -r .env ]] && source .env

# Set env vars
export SERVER_NAME=${CUR_DIR##*/}.devel.lib.msu.edu # TODO not ideal
export DISPLAY=:2
export PATH=/usr/local/bin:/usr/bin:$PATH

# Start headless browser # TODO not sure why this isn't working, need to do this manually for now
#Xvfb :2 -ac &
#PID=$!

# Run the tests
if [[ $TEST_TYPE == "functional" ]]; then
    # Set instance dir
    export INSTANCE_DIR=$CUR_DIR/instance
    pytest -m functional --no-cov -n 4
elif [[ $TEST_TYPE == "unit" ]]; then
    export INSTANCE_DIR=$CUR_DIR/sandhill/test_instance
    pytest
else
    echo "ERROR: Unknown test type of '$TEST_TYPE'"
    exit 1
fi

# Stop headless server TODO not working
#kill $PID

# Return
popd
